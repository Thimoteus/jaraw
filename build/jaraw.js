(function(){var a,b,c,d,e,f;b=require("iced-runtime"),e=f=function(){},c=require("request"),d=require("./validate"),a=function(){function a(a){switch("object"==typeof a?(d.isOptions(a),d.hasUserAgent(a)):(d.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":d.isScript(a);break;case"web":d.isWebApp(a);break;case"installed":d.isInstalledApp(a)}"rate_limit"in a?a.rate_limit<2e3&&("anon"===a.type?a.rate_limit=2e3:a.rate_limit<1e3&&(a.rate_limit=1e3)):a.rate_limit=2e3,this.next_call=Date.now()+a.rate_limit,this.options=a}return a.prototype.loginAs=function(a,b){switch(a){case"script":return this.loginAsScript(b);case"web":return this.loginAsWeb(b);case"installed":return this.loginAsInstalled(b);default:throw new Error("incorrect login type")}},a.prototype.loginAsScript=function(a){var d,e,g,h,i,j,k,l,m;m=f,k=b.findDeferral(arguments),e=this.options.login,g=this.options.oauth,i=function(a){var d,h,i,j,k,l,m,n;n=f,l=b.findDeferral(arguments),j={grant_type:"password",username:e.username,password:e.password},i={url:"https://ssl.reddit.com/api/v1/access_token",method:"POST",form:j,auth:{user:g.id,pass:g.secret}},function(){return function(a){m=new b.Deferrals(a,{parent:l,filename:"src/jaraw.iced"}),c(i,m.defer({assign_fn:function(){return function(){return d=arguments[0],h=arguments[1],k=arguments[2]}}(),lineno:53})),m._fulfill()}}(this)(function(){return function(){return a(d,k)}}(this))},h=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(){return function(a){l=new b.Deferrals(a,{parent:k,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),i(l.defer({assign_fn:function(){return function(){return d=arguments[0],j=arguments[1]}}(),lineno:59})),l._fulfill()}}(this)(function(b){return function(){return b.auth=h(j),a(b.auth)}}(this))},a.prototype._call=function(a,e,g,h){var i,j,k,l,m,n,o,p,q,r,s;s=f,q=b.findDeferral(arguments),p=Date.now()-this.next_call,function(){return function(a){return 0>p?void!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),setTimeout(r.defer({lineno:65}),p),r._fulfill()}(a):a()}}(this)(function(p){return function(){d.isHTTPMethod(a),p.auth&&d.hasValidAuth(p.auth),"function"==typeof g&&(h=g,g={}),n="get"===a.toLowerCase()?{qs:g}:{form:g},n.url=p.options.oauth?"https://oauth.reddit.com":"https://www.reddit.com",n.url+=e,m=p,k=function(d){var e,g,h,i,j,k,l;l=f,j=b.findDeferral(arguments),h={"User-Agent":p.options.user_agent},p.auth&&(h.Authorization="bearer "+p.auth.access_token),n.headers=h,function(d){k=new b.Deferrals(d,{parent:j,filename:"src/jaraw.iced"}),c[a.toLowerCase()](n,k.defer({assign_fn:function(){return function(){return g=arguments[0],i=arguments[1],e=arguments[2]}}(),lineno:86})),k._fulfill()}(function(){return d(g,i,e)})},function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],o=arguments[1],j=arguments[2]}}(),lineno:89})),r._fulfill()}(function(){!function(a){var c;return 401!==(c=o.statusCode)&&403!==c?a():void!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),p.loginAs(p.options.type,r.defer({assign_fn:function(){return function(){return i=arguments[0]}}(),lineno:92})),r._fulfill()}(function(){!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],o=arguments[1],j=arguments[2]}}(),lineno:93})),r._fulfill()}(function(){return a(l?void 0:p.next_call=Date.now()+p.options.rate_limit)})})}(function(){return h(l,o,j)})})}}(this))},a.prototype.get=function(a,b,c){return null==b&&(b={}),this._call("get",a,b,c)},a.prototype.post=function(a,b,c){return null==b&&(b={}),this._call("post",a,b,c)},a}(),module.exports=a}).call(this);