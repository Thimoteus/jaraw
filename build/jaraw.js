(function(){var Jaraw,a,b,c,d,e,f;a=require("iced-runtime"),e=f=function(){},c=require("request"),d=require("./validate"),b=function(a){return a},Jaraw=function(){function Jaraw(a){switch("object"==typeof a?(d.isOptions(a),d.hasUserAgent(a)):(d.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":d.isScript(a);break;case"web":d.isWebApp(a);break;case"installed":d.isInstalledApp(a)}"rate_limit"in a?a.rate_limit<2e3&&("anon"===a.type?a.rate_limit=2e3:a.rate_limit<1e3&&(a.rate_limit=1e3)):a.rate_limit=2e3,this.next_call=Date.now()+a.rate_limit,this.options=a}return Jaraw.prototype.loginAs=function(a,c){switch(null==c&&(c=b),a){case"script":return this.loginAsScript(c);case"web":return this.loginAsWeb(c);case"installed":return this.loginAsInstalled(c);default:throw new Error("incorrect login type")}},Jaraw.prototype.loginAsScript=function(d){var e,g,h,i,j,k,l,m,n;n=f,l=a.findDeferral(arguments),null==d&&(d=b),g=this.options.login,h=this.options.oauth,j=function(b){var d,e,i,j,k,l,m,n;n=f,l=a.findDeferral(arguments),j={grant_type:"password",username:g.username,password:g.password},i={url:"https://ssl.reddit.com/api/v1/access_token",method:"POST",form:j,auth:{user:h.id,pass:h.secret}},function(){return function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced"}),c(i,m.defer({assign_fn:function(){return function(){return d=arguments[0],e=arguments[1],k=arguments[2]}}(),lineno:55})),m._fulfill()}}(this)(function(){return function(){return b(d,k)}}(this))},i=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(){return function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),j(m.defer({assign_fn:function(){return function(){return e=arguments[0],k=arguments[1]}}(),lineno:61})),m._fulfill()}}(this)(function(a){return function(){return a.auth=i(k),d(a.auth)}}(this))},Jaraw.prototype.call=function(b,e,g,h){var i,j,k,l,m,n,o,p,q,r,s;s=f,q=a.findDeferral(arguments),p=Date.now()-this.next_call,function(){return function(b){return 0>p?void!function(b){r=new a.Deferrals(b,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),setTimeout(r.defer({lineno:67}),p),r._fulfill()}(b):b()}}(this)(function(p){return function(){d.isHTTPMethod(b),p.auth&&d.hasValidAuth(p.auth),"function"==typeof g&&(h=g,g={}),n="get"===b.toLowerCase()?{qs:g}:{form:g},n.url=p.options.oauth?"https://oauth.reddit.com":"https://www.reddit.com",n.url+=e,m=p,k=function(d){var e,g,h,i,j,k,l;l=f,j=a.findDeferral(arguments),h={"User-Agent":p.options.user_agent},p.auth&&(h.Authorization="bearer "+p.auth.access_token),n.headers=h,function(d){k=new a.Deferrals(d,{parent:j,filename:"src/jaraw.iced"}),c[b.toLowerCase()](n,k.defer({assign_fn:function(){return function(){return g=arguments[0],i=arguments[1],e=arguments[2]}}(),lineno:88})),k._fulfill()}(function(){return d(g,i,e)})},function(b){r=new a.Deferrals(b,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],o=arguments[1],j=arguments[2]}}(),lineno:91})),r._fulfill()}(function(){!function(b){var c;return 401!==(c=o.statusCode)&&403!==c?b():void!function(b){r=new a.Deferrals(b,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),p.loginAs(p.options.type,r.defer({assign_fn:function(){return function(){return i=arguments[0]}}(),lineno:94})),r._fulfill()}(function(){!function(b){r=new a.Deferrals(b,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],o=arguments[1],j=arguments[2]}}(),lineno:95})),r._fulfill()}(function(){return b(l?void 0:p.next_call=Date.now()+p.options.rate_limit)})})}(function(){return h(l,o,j)})})}}(this))},Jaraw.prototype.get=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("get",a,c,d)},Jaraw.prototype.post=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("post",a,c,d)},Jaraw.prototype.logout=function(d){var e,g,h,i,j,k,l;l=f,j=a.findDeferral(arguments),null==d&&(d=b),h={url:"https://ssl.reddit.com/api/v1/revoke_token",method:"POST",auth:{user:this.options.oauth.id,pass:this.options.oauth.secret},form:{token:this.auth.access_token,token_type_hint:"access_token"}},function(){return function(b){k=new a.Deferrals(b,{parent:j,filename:"src/jaraw.iced",funcname:"Jaraw.logout"}),c(h,k.defer({assign_fn:function(){return function(){return e=arguments[0],i=arguments[1],g=arguments[2]}}(),lineno:114})),k._fulfill()}}(this)(function(){return function(){return console.log("Logged out!"),d(e,i,g)}}(this))},Jaraw}(),module.exports=Jaraw}).call(this);