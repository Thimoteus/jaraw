(function(){var Jaraw,a,b,c,d,e,f,g;a=require("iced-runtime"),f=g=function(){},d=require("request"),e=require("./validate"),b=function(a){return a},c=function(a,b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],f.push(a(c));return f},Jaraw=function(){function Jaraw(a){switch("object"==typeof a?(e.isOptions(a),e.hasUserAgent(a)):(e.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":e.isScript(a);break;case"web":e.isWebApp(a);break;case"installed":e.isInstalledApp(a)}"rate_limit"in a?a.rate_limit<2e3&&("anon"===a.type?a.rate_limit=2e3:a.rate_limit<1e3&&(a.rate_limit=1e3)):a.rate_limit=2e3,this.next_call=Date.now()+a.rate_limit,this.options=a}return Jaraw.prototype.refreshAccess=function(a,c){switch(null==c&&(c=b),a){case"script":return this.loginAsScript(c);case"web":return this.refreshWebAccess();case"installed":return this.refreshInstalledAccess();default:throw new Error("incorrect login type")}},Jaraw.prototype.loginAsScript=function(c){var e,f,h,i,j,k,l,m,n;n=g,l=a.findDeferral(arguments),null==c&&(c=b),f=this.options.login,h=this.options.oauth,j=function(b){var c,e,i,j,k,l,m;m=g,k=a.findDeferral(arguments),i={url:"https://ssl.reddit.com/api/v1/access_token",method:"POST",form:{grant_type:"password",username:f.username,password:f.password},auth:{user:h.id,pass:h.secret}},function(){return function(b){l=new a.Deferrals(b,{parent:k,filename:"src/jaraw.iced"}),d(i,l.defer({assign_fn:function(){return function(){return c=arguments[0],e=arguments[1],j=arguments[2]}}(),lineno:65})),l._fulfill()}}(this)(function(){return function(){return b(c,j)}}(this))},i=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(){return function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),j(m.defer({assign_fn:function(){return function(){return e=arguments[0],k=arguments[1]}}(),lineno:75})),m._fulfill()}}(this)(function(b){return function(){!function(c){return k?c(b.auth=i(k)):(console.log("Login attempt failed, trying again in 2 seconds"),void function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),setTimeout(m.defer({lineno:80}),2e3),m._fulfill()}(function(){!function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),loginAsScript(m.defer({lineno:81})),m._fulfill()}(c)}))}(function(){return c(b.auth)})}}(this))},Jaraw.prototype.getInstalledAuthToken=function(a){var b,c,d,e,f,g,h,i;return h=this.options.oauth,g=function(){return Math.random().toString(36).slice(2)},e=a||g()+g(),b=h.id,f=h.redirect_uri,c=h.scopes,d=c.join(","),i="https://www.reddit.com/api/v1/authorize? client_id="+b+"& response_type=token& state="+e+"& redirect_uri="+f+"& scope="+d,i.split(" ").join("")},Jaraw.prototype.call=function(b,c,f,h){var i,j,k,l,m,n,o,p,q,r;r=g,p=a.findDeferral(arguments),o=Date.now()-this.next_call,function(){return function(b){return 0>o?void!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),setTimeout(q.defer({lineno:109}),o),q._fulfill()}(b):b()}}(this)(function(o){return function(){e.isHTTPMethod(b),o.auth&&e.hasValidAuth(o.auth),"function"==typeof f&&(h=f,f={}),m="get"===b.toLowerCase()?{qs:f}:{form:f},m.url=o.options.oauth?"https://oauth.reddit.com":"https://www.reddit.com",m.url+=c,k=function(c){var e,f,h,i,j,k,l;l=g,j=a.findDeferral(arguments),h={"User-Agent":o.options.user_agent},o.auth&&(h.Authorization="bearer "+o.auth.access_token),m.headers=h,function(c){k=new a.Deferrals(c,{parent:j,filename:"src/jaraw.iced"}),d[b.toLowerCase()](m,k.defer({assign_fn:function(){return function(){return f=arguments[0],i=arguments[1],e=arguments[2]}}(),lineno:135})),k._fulfill()}(function(){return c(f,i,e)})},function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(q.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:138})),q._fulfill()}(function(){!function(b){var c;return 401!==(c="undefined"!=typeof n&&null!==n?n.statusCode:void 0)&&403!==c?b():void!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),o.refreshAccess(o.options.type,q.defer({assign_fn:function(){return function(){return i=arguments[0]}}(),lineno:142})),q._fulfill()}(function(){!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(q.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:143})),q._fulfill()}(function(){return b(l?void 0:o.next_call=Date.now()+o.options.rate_limit)})})}(function(){return!l&&n&&j||h(new Error("Could not reach the reddit servers")),200!==n.statusCode&&h(new Error("Could not reach reddit: "+n.statusCode)),h(null,j)})})}}(this))},Jaraw.prototype.get=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("get",a,c,d)},Jaraw.prototype.post=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("post",a,c,d)},Jaraw.prototype.getListing=function(d,e,f){var h,i,j,k,l,m;m=g,k=a.findDeferral(arguments),null==e&&(e={}),null==f&&(f=b),j=function(a){return c(function(a){return a.data},JSON.parse(a).data.children)},function(b){return function(c){l=new a.Deferrals(c,{parent:k,filename:"src/jaraw.iced",funcname:"Jaraw.getListing"}),b.get(d,e,l.defer({assign_fn:function(){return function(){return i=arguments[0],h=arguments[1]}}(),lineno:163})),l._fulfill()}}(this)(function(){return function(){return i?f(i):f(null,j(h))}}(this))},Jaraw.prototype.pm=function(a,c,d,e){var f;return null==e&&(e=b),/\/u\//i.test(a)&&(a=a.slice(3)),f={api_type:"json",subject:c,text:d,to:a},this.post("api/compose",f,e)},Jaraw.prototype.replyTo=function(a,c,d){var e;return null==d&&(d=b),e={api_type:"json",thing_id:a,text:c},this.post("/api/comment",e,d)},Jaraw.prototype.logout=function(c){var e,f,h,i,j,k,l;l=g,j=a.findDeferral(arguments),null==c&&(c=b),h={url:"https://ssl.reddit.com/api/v1/revoke_token",method:"POST",auth:{user:this.options.oauth.id,pass:this.options.oauth.secret},form:{token:this.auth.access_token,token_type_hint:"access_token"}},function(){return function(b){k=new a.Deferrals(b,{parent:j,filename:"src/jaraw.iced",funcname:"Jaraw.logout"}),d(h,k.defer({assign_fn:function(){return function(){return e=arguments[0],i=arguments[1],f=arguments[2]}}(),lineno:205})),k._fulfill()}}(this)(function(){return function(){return console.log("Logged out!"),c(e,i,f)}}(this))},Jaraw}(),module.exports=Jaraw}).call(this);