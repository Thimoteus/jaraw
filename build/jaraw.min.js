(function(){var a,b,c,d,e,f,g;b=require("iced-runtime"),f=g=function(){},d=require("request"),c=require("querystring"),e=require("./validate"),a=function(){function a(a){switch("object"==typeof a?(e.isOptions(a),e.hasUserAgent(a)):(e.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":e.isScript(a);break;case"web":e.isWebApp(a);break;case"installed":e.isInstalledApp(a)}"rate_limit"in a?a.rate_limit<2e3&&("anon"===a.type?a.rate_limit=2e3:a.rate_limit<1e3&&(a.rate_limit=1e3)):a.rate_limit=2e3,this.next_call=Date.now()+a.rate_limit,this.options=a}return a.prototype.loginAs=function(a,b){switch(a){case"script":return this.loginAsScript(b);case"web":return this.loginAsWeb(b);case"installed":return this.loginAsInstalled(b);default:throw new Error("incorrect login type")}},a.prototype.loginAsScript=function(a){var e,f,h,i,j,k,l,m,n;n=g,l=b.findDeferral(arguments),f=this.options.login,h=this.options.oauth,j=function(a){var e,i,j,k,l,m,n,o;o=g,m=b.findDeferral(arguments),e=c.stringify({grant_type:"password",username:f.username,password:f.password}),k={url:"https://ssl.reddit.com/api/v1/access_token?"+e,method:"POST",auth:{user:h.id,pass:h.secret}},function(){return function(a){n=new b.Deferrals(a,{parent:m,filename:"src/jaraw.iced"}),d(k,n.defer({assign_fn:function(){return function(){return i=arguments[0],j=arguments[1],l=arguments[2]}}(),lineno:53})),n._fulfill()}}(this)(function(){return function(){return a(i,l)}}(this))},i=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(){return function(a){m=new b.Deferrals(a,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),j(m.defer({assign_fn:function(){return function(){return e=arguments[0],k=arguments[1]}}(),lineno:59})),m._fulfill()}}(this)(function(b){return function(){return b.auth=i(k),a(b.auth)}}(this))},a.prototype._call=function(a,c,f,h){var i,j,k,l,m,n,o,p,q,r,s;s=g,q=b.findDeferral(arguments),o=Date.now()-this.next_call,function(){return function(a){return 0>o?void!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),setTimeout(r.defer({lineno:65}),o),r._fulfill()}(a):a()}}(this)(function(o){return function(){e.isHTTPMethod(a),o.auth&&e.hasValidAuth(o.auth),"function"==typeof f&&(h=f,f={}),"anon"===o.options.type&&(p="https://www.reddit.com"),o.options.oauth&&(p="https://oauth.reddit.com"),p+=c,m=o,k=function(c){var e,h,i,j,k,l,n;n=g,k=b.findDeferral(arguments),f.url=p,i={"User-Agent":m.options.user_agent},this.auth&&(i.Authorization="bearer "+m.auth.access_token),f.headers=i,function(){return function(c){l=new b.Deferrals(c,{parent:k,filename:"src/jaraw.iced"}),d[a.toLowerCase()](f,l.defer({assign_fn:function(){return function(){return h=arguments[0],j=arguments[1],e=arguments[2]}}(),lineno:83})),l._fulfill()}}(this)(function(){return function(){return c(h,j,e)}}(this))},function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:86})),r._fulfill()}(function(){!function(a){var c;return 401!==(c=n.statusCode)&&403!==c?a():void!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),o.loginAs(o.options.type,r.defer({assign_fn:function(){return function(){return i=arguments[0]}}(),lineno:89})),r._fulfill()}(function(){!function(a){r=new b.Deferrals(a,{parent:q,filename:"src/jaraw.iced",funcname:"Jaraw._call"}),k(r.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:90})),r._fulfill()}(function(){return a(l?void 0:o.next_call=Date.now()+o.options.rate_limit)})})}(function(){return h(l,n,j)})})}}(this))},a.prototype.get=function(a,b,c){return null==b&&(b={}),this._call("get",a,b,c)},a.prototype.post=function(a,b,c){return null==b&&(b={}),this._call("post",a,b,c)},a}(),module.exports=a}).call(this);