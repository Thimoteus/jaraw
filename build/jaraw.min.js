(function(){var a,b,c,d,e,f,g,h=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=require("iced-runtime"),f=g=function(){},d=require("request"),c=require("querystring"),e=require("./validate"),a=function(){function a(a){switch("object"==typeof a?(e.isOptions(a),e.hasUserAgent(a)):(e.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":e.isScript(a);break;case"web":e.isWebApp(a);break;case"installed":e.isInstalledApp(a)}"rate_limit"in a||(a.rate_limit=2e3),this.next_call=Date.now()+a.rate_limit,this.options=a}return a.prototype.loginAsScript=function(a){var e,f,h,i,j,k,l,m,n;n=g,l=b.findDeferral(arguments),f=this.options.login,h=this.options.oauth,j=function(a){var e,i,j,k,l,m,n,o;o=g,m=b.findDeferral(arguments),e=c.stringify({grant_type:"password",username:f.username,password:f.password}),k={url:"https://ssl.reddit.com/api/v1/access_token?"+e,method:"POST",auth:{user:h.id,pass:h.secret}},function(){return function(a){n=new b.Deferrals(a,{parent:m}),d(k,n.defer({assign_fn:function(){return function(){return i=arguments[0],j=arguments[1],l=arguments[2]}}(),lineno:39})),n._fulfill()}}(this)(function(){return function(){return a(i,l)}}(this))},i=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(a){return function(c){return a.auth?c():void!function(a){m=new b.Deferrals(a,{parent:l,funcname:"Jaraw.loginAsScript"}),j(m.defer({assign_fn:function(){return function(){return e=arguments[0],k=arguments[1]}}(),lineno:46})),m._fulfill()}(function(){return c(a.auth=i(k))})}}(this)(function(b){return function(){return a(b.auth)}}(this))},a.prototype._call=function(a,c,f,h){var i,j,k,l,m,n,o,p,q;q=g,o=b.findDeferral(arguments),m=Date.now()-this.next_call,function(){return function(a){return 0>m?void!function(a){p=new b.Deferrals(a,{parent:o,funcname:"Jaraw._call"}),setTimeout(p.defer({lineno:52}),m),p._fulfill()}(a):a()}}(this)(function(m){return function(){e.isHTTPMethod(a),m.auth&&e.hasValidAuth(m.auth),"function"==typeof f&&(h=f,f={}),"anon"===m.options.type&&(n="https://www.reddit.com"),m.auth&&(n="https://oauth.reddit.com"),n+=c,k=m,i=function(c){var e,h,i,j,l,m,o;o=g,l=b.findDeferral(arguments),f.url=n,h={"User-Agent":k.options.user_agent},this.auth&&(h.Authorization="bearer "+k.auth.access_token),f.headers=h,function(){return function(c){m=new b.Deferrals(c,{parent:l}),d[a.toLowerCase()](f,m.defer({assign_fn:function(){return function(){return e=arguments[0],i=arguments[1],j=arguments[2]}}(),lineno:70})),m._fulfill()}}(this)(function(){return function(){return c(e,j)}}(this))},function(a){p=new b.Deferrals(a,{parent:o,funcname:"Jaraw._call"}),i(p.defer({assign_fn:function(){return function(){return j=arguments[0],l=arguments[1]}}(),lineno:73})),p._fulfill()}(function(){return j||(m.next_call=Date.now()+m.options.rate_limit),h(j,l)})}}(this))},a.prototype.get=function(a,b,c){return null==b&&(b={}),this._call("get",a,b,c)},a.prototype.post=function(a,b,c){return null==b&&(b={}),this._call("post",a,b,c)},a}(),module.exports=a,e={isOptions:function(a){var b,c;if(null==a.type)throw new Error("type must be defined");if(b=["script","web","installed","anon"],c=a.type,h.call(b,c)<0)throw new Error("type must be one of "+b.join(", "))},isScript:function(a){var b,c,d,e;if(!((null!=(b=a.login)?b.username:void 0)||(null!=(c=a.login)?c.password:void 0)))throw new Error("must provide username and password");if(!((null!=(d=a.oauth)?d.id:void 0)||(null!=(e=a.oauth)?e.secret:void 0)))throw new Error("must provide client ID and secret")},isWebApp:function(a){return e.isOptions(a)},isInstalledApp:function(a){return e.isOptions(a)},hasUserAgent:function(a){if(null==a.user_agent)throw new Error("need to define a user agent");if(0===a.user_agent.length)throw new Error("need a custom user agent")},isHTTPMethod:function(a){var b;if("get"!==(b=a.toLowerCase())&&"post"!==b)throw new Error("must be a GET or POST request")},hasValidAuth:function(a){if(!("access_token"in a))throw new Error("you don't have an access token")},_isProperString:function(a,b,c){if("string"!=typeof a)throw new Error(b);if(0===a.length)throw new Error(c)},isUserAgent:function(a){return e._isProperString(a,"must provide a user agent","user agent must not be empty")}},module.exports=e}).call(this);